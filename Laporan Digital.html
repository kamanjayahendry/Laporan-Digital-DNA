<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Generator Laporan Kegiatan</title>

<style>
body {
    font-family: "Arial", sans-serif;
    background: #e9e9e9;
    padding: 30px;
}
.container {
    background: #fff;
    padding: 30px;
    border-radius: 10px;
    max-width: 900px;
    margin: auto;
}
input, textarea {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    margin-bottom: 15px;
    border: 1px solid #bbb;
    border-radius: 5px;
}
label {
    font-weight: bold;
    display: block;
}
button {
    background: #1976d2;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}
button:hover { background: #0d47a1; }

#preview {
    width: 794px;
    min-height: 1123px;
    padding: 40px 60px;
    margin: 50px auto;
    background: white;
    border: 1px solid #ccc;
    text-align: justify;
    line-height: 1.6;
    overflow-wrap: break-word;
    word-wrap: break-word;
    hyphens: auto;
}

#preview table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
}

#preview table td {
    word-wrap: break-word;
    vertical-align: top;
}

#preview img {
    max-width: 500px;
    max-height: 400px;
    margin-top: 20px;
    border: 1px solid #bbb;
    object-fit: contain;
}

.judul-laporan {
    text-align: center;
    font-weight: bold;
    font-size: 20px;
    margin-bottom: 30px;
    text-transform: uppercase;
}
.ttd { margin-top: 60px; text-align: right; }
canvas { border: 1px solid #333; margin-top: 10px; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>

<body>
<div class="container">
    <h2 style="text-align:center;">FORM LAPORAN KEGIATAN</h2>

    <label>Nama Acara</label>
    <input id="acara">

    <label>Hari / Tanggal</label>
    <input id="tanggal" type="date">

    <label>Waktu</label>
    <input id="waktu" placeholder="13.00 Wita s/d selesai">

    <label>Tempat</label>
    <input id="tempat">

    <label>Jenis Kegiatan</label>
    <input id="jenis">

    <label>Rencana Aksi</label>
    <input id="renaksi">

    <label>Penjelasan Kegiatan</label>
    <textarea id="penjelasan" rows="4"></textarea>

    <label>Kesimpulan</label>
    <textarea id="kesimpulan" rows="3"></textarea>

    <label>Foto Kegiatan</label>
    <input id="foto" type="file" accept="image/*">

    <hr>

    <h3>Tanda Tangan Digital</h3>
    <canvas id="canvas" width="300" height="150"></canvas><br>
    <button onclick="clearCanvas()" style="margin-top:10px;">Bersihkan TTD</button>

    <label>Nama Notulen</label>
    <input id="namaTTD" placeholder="Masukkan nama lengkap">

    <label>Jabatan</label>
    <input id="jabatanTTD" placeholder="Masukkan jabatan">

    <br><br>
    <button onclick="generatePreview()">Preview</button>
    <button onclick="exportPDF()">Export ke PDF (≤2MB)</button>

    <div id="preview"></div>
</div>

<script>
// ===============================
//      TTD CANVAS SUPPORT HP
// ===============================
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let drawing = false;
ctx.lineWidth = 2; ctx.lineCap = "round"; ctx.strokeStyle = "#000";

canvas.addEventListener("mousedown", e => { drawing = true; startDraw(e); });
canvas.addEventListener("mousemove", e => { if(drawing) draw(e); });
canvas.addEventListener("mouseup", () => { drawing = false; ctx.beginPath(); });

canvas.addEventListener("touchstart", e => { e.preventDefault(); drawing = true; startDraw(e.touches[0]); });
canvas.addEventListener("touchmove", e => { e.preventDefault(); if(drawing) draw(e.touches[0]); });
canvas.addEventListener("touchend", () => { drawing = false; ctx.beginPath(); });

function startDraw(e) {
    const rect = canvas.getBoundingClientRect();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}
function draw(e){
    const rect = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
}
function clearCanvas(){ ctx.clearRect(0,0,canvas.width,canvas.height); }

// ===============================
//      GENERATE PREVIEW
// ===============================
function generatePreview() {
    const acara = document.getElementById("acara").value;
    const rawTanggal = document.getElementById("tanggal").value;
    const dateObj = new Date(rawTanggal);
    const bulanIndo = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
    const tanggal = dateObj.getDate()+" "+bulanIndo[dateObj.getMonth()]+" "+dateObj.getFullYear();

    const waktu = document.getElementById("waktu").value;
    const tempat = document.getElementById("tempat").value;
    const jenis = document.getElementById("jenis").value;
    const renaksi = document.getElementById("renaksi").value;
    const penjelasan = document.getElementById("penjelasan").value;
    const kesimpulan = document.getElementById("kesimpulan").value;
    const namaTTD = document.getElementById("namaTTD").value;
    const jabatanTTD = document.getElementById("jabatanTTD").value;

    const fotoFile = document.getElementById("foto").files[0];

    if(fotoFile){
        compressImage(fotoFile, 1280, 0.7).then(resizeURL=>{
            showPreview(acara, tanggal, waktu, tempat, jenis, renaksi, penjelasan, kesimpulan, namaTTD, jabatanTTD, resizeURL);
        });
    } else {
        showPreview(acara, tanggal, waktu, tempat, jenis, renaksi, penjelasan, kesimpulan, namaTTD, jabatanTTD, "");
    }
}

function showPreview(acara, tanggal, waktu, tempat, jenis, renaksi, penjelasan, kesimpulan, namaTTD, jabatanTTD, fotoURL){
    let fotoHTML = fotoURL ? `<img src="${fotoURL}">` : "";
    document.getElementById("preview").innerHTML = `
        <div class="judul-laporan">LAPORAN KEGIATAN</div>
        <table>
            <tr><td style="width:200px;"><b>Acara Kegiatan</b></td><td>: ${acara}</td></tr>
            <tr><td><b>Hari / Tanggal</b></td><td>: ${tanggal}</td></tr>
            <tr><td><b>Pukul</b></td><td>: ${waktu}</td></tr>
            <tr><td><b>Tempat</b></td><td>: ${tempat}</td></tr>
            <tr><td><b>Jenis Kegiatan</b></td><td>: ${jenis}</td></tr>
            <tr><td><b>Rencana Aksi</b></td><td>: ${renaksi}</td></tr>
        </table>
        <br><b>Penjelasan Kegiatan:</b>
        <p style="white-space: normal;">${penjelasan}</p>
        <br><b>Kesimpulan:</b>
        <p style="white-space: normal;">${kesimpulan}</p>
        <br><b>Foto Kegiatan:</b><br>${fotoHTML}
        <div class="ttd">
            <p><b>Denpasar, ${tanggal}</b></p>
            <p><b>${jabatanTTD}</b></p>
            <img src="${canvas.toDataURL()}" width="200"><br><br>
            <b><u>${namaTTD}</u></b><br>
        </div>
    `;
}

// ===============================
//      KOMPRES IMAGE
// ===============================
function compressImage(file, maxWidth=1280, quality=0.7){
    return new Promise(resolve=>{
        const img = new Image();
        const reader = new FileReader();
        reader.onload = e => img.src = e.target.result;
        img.onload = () => {
            const canvas = document.createElement("canvas");
            let width = img.width;
            let height = img.height;
            if(width>maxWidth){ height = height*(maxWidth/width); width = maxWidth; }
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img,0,0,width,height);
            canvas.toBlob(blob=> resolve(URL.createObjectURL(blob)), "image/jpeg", quality);
        };
        reader.readAsDataURL(file);
    });
}

// ===============================
//      EXPORT PDF ≤2MB
// ===============================
async function exportPDF(){
    const { jsPDF } = window.jspdf;
    const preview = document.getElementById("preview");

    async function generateJPEG(scale=1, quality=0.7){
        const canvas = await html2canvas(preview,{scale:scale, useCORS:true});
        return canvas.toDataURL("image/jpeg", quality);
    }

    let quality = 0.7, scale=1, pdfBlob, attempts=0;

    do{
        const imgData = await generateJPEG(scale, quality);
        const pdf = new jsPDF("p","pt","a4");
        pdf.addImage(imgData,"JPEG",0,0,595,842);
        pdfBlob = pdf.output("blob");
        const sizeMB = pdfBlob.size/(1024*1024);
        if(sizeMB>2){
            quality-=0.1;
            if(quality<0.3){ scale-=0.1; quality=0.5; }
        } else { break; }
        attempts++;
    } while((pdfBlob.size/(1024*1024))>2 && attempts<10);

    const finalPdf = new jsPDF("p","pt","a4");
    const finalImg = await generateJPEG(scale, quality);
    finalPdf.addImage(finalImg,"JPEG",0,0,595,842);
    finalPdf.save("LaporanKegiatan.pdf");
}
</script>
</body>
</html>
